package server;

import bean.AttivitaBean;
import bean.PersonaBean;
import bean.PreferitiBean;
import bean.PrenotazioneBean;
import dao.AttivitaDAO;
import dao.PreferitiDAO;
import dao.PrenotazioneDAO;

import javax.servlet.RequestDispatcher;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.sql.SQLException;
import java.util.ArrayList;

@WebServlet("/ServletPreferiti")
public class servletPreferiti extends HttpServlet {
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        AttivitaDAO adao = new AttivitaDAO();
        ArrayList<AttivitaBean> attivita = new ArrayList<>();
        PreferitiDAO pdao = new PreferitiDAO();
        PersonaBean user=(PersonaBean)request.getSession().getAttribute("cliente");
        if(request.getParameter("action")!=null && request.getParameter("action").equals("pref")){
            ArrayList<PreferitiBean> preferiti = null;
            try {
                preferiti = pdao.doRetrieveByUser(user.getUsername());
            } catch (SQLException throwables) {
                throwables.printStackTrace();
            }
            for(PreferitiBean p :preferiti){
                attivita.add(adao.doRetrieveByKey(p.getAttivitaIDAttivita()));
            }
        }

        else {
            int codice = Integer.parseInt(request.getParameter("Codice"));
            try {
                pdao.doSave(new PreferitiBean(user.getUsername(), codice));
            } catch (SQLException throwables) {
                throwables.printStackTrace();
            }
            ArrayList<PreferitiBean> pref = null;
            try {
                pref = pdao.doRetrieveByUser(user.getUsername());
            } catch (SQLException e) {
                // TODO Auto-generated catch block
                e.printStackTrace();
            }


            for (PreferitiBean p : pref) {
                attivita.add(adao.doRetrieveByKey(p.getAttivitaIDAttivita()));
            }

            //Preferiti pref = (Preferiti) session.getAttribute("Preferiti");
        }
            request.setAttribute("Preferiti", attivita);
            request.setAttribute("Utente", user.getNome());

            //request.setAttribute("prodotti", prodotti);

            RequestDispatcher dispatcher = getServletContext().getRequestDispatcher("/VisualizzazionePreferiti.jsp");
            dispatcher.forward(request, response);
    }

    protected void doPost(HttpServletRequest request, HttpServletResponse response) throws ServletException, IOException {
        // TODO Auto-generated method stub
        doGet(request, response);
    }












































































































































































































































































































































































































































































































































































































































































































































































































































































































































































}

























































































































































































































































































































































































